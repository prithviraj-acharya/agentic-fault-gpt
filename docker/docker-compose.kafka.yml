name: agentic-fault-gpt

services:
  kafka:
    image: public.ecr.aws/bitnami/kafka:4.1.1
    container_name: afg-kafka
    ports:
      - "9092:9092"
    environment:
      # KRaft mode (no ZooKeeper)
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      # Kafka 4.x (dynamic quorum) expects bootstrap servers rather than a static voter set.
      - KAFKA_CFG_CONTROLLER_QUORUM_BOOTSTRAP_SERVERS=kafka:9093
      # Required for dynamic quorum formatting (see `kafka-storage.sh format --help`).
      - KAFKA_INITIAL_CONTROLLERS=1@kafka:9093:BVq4h7bERU2mwhpFIiY2Uw
      # Any stable 22-char base64-like string works for local dev.
      # Prefer a real one from `kafka-storage.sh random-uuid`.
      - KAFKA_KRAFT_CLUSTER_ID=Lwl-msppTbOkTwyUlspLUw

      # Listeners
      # - PLAINTEXT is for host-machine clients (advertises localhost:9092)
      # - PLAINTEXT_INTERNAL is for other containers (advertises kafka:29092)
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,PLAINTEXT_INTERNAL://:29092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT_INTERNAL
      - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data

      # Single node dev defaults
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_CFG_GROUP_INITIAL_REBALANCE_DELAY_MS=0

      # Required by bitnami images
      - ALLOW_PLAINTEXT_LISTENER=yes
    volumes:
      - kafka_data:/bitnami/kafka

  kafka-ui:
    image: provectuslabs/kafka-ui:v0.7.2
    container_name: afg-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:29092

volumes:
  kafka_data:
